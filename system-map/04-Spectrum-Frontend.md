# Spectrum Frontend - CloudFlare Pages

## Status: ACTIVE & DEPLOYED

## Purpose
User-facing interface for Spectrum multi-agent AI system. Displays 4 agents with chat interface.

## Infrastructure

### Deployment
- **Platform**: CloudFlare Pages
- **URL**: https://spectrum.aijesusbro.com
- **Source**: `/Users/aijesusbro/AI Projects/aijesusbro.com/spectrum/`
- **Build Output**: `/dist` (generated by Vite)

### Stack
- **Framework**: Vanilla JavaScript (no React/Vue)
- **Build Tool**: Vite
- **Animations**: GSAP (GreenSock)
- **Markdown**: Marked.js (for AI response rendering)
- **Styling**: Tailwind CSS

## Key Components

### 1. Frontend App (`src/app.js`)
- Single-page application
- Lead gate (collect email/name before chat)
- Agent selector (4 agent buttons)
- Chat interface with streaming responses
- Markdown rendering for AI messages

### 2. API Proxy (`functions/api/[[path]].js`)
**CRITICAL**: This is the bridge between frontend and backend!

```javascript
const BACKEND_URL = 'http://api.spectrum.aijesusbro.com:8082';
// Proxies all /api/* requests to DigitalOcean backend
```

### Architecture Flow
```
User Browser
    ↓ fetch('/api/chat')
CloudFlare Pages (spectrum.aijesusbro.com)
    ↓ functions/api/[[path]].js
http://api.spectrum.aijesusbro.com:8082
    ↓ (DNS resolves to 64.23.221.37)
DigitalOcean Backend (spectrum-api container)
```

### 3. Lead Capture (`functions/api/submit-lead.js`)
- Stores leads in D1 database
- Database: `spectrum-leads` (ID: c4de2db9-f8eb-4419-bdf6-647de1fb463e)
- Collects: name, email, timestamp

### 4. Analytics (`functions/api/track-access.js`)
- Tracks page visits
- May use D1 or KV store

## Database (D1)

### spectrum-leads
- **Binding**: `DB`
- **ID**: c4de2db9-f8eb-4419-bdf6-647de1fb463e
- **Purpose**: Store lead form submissions
- **Tables**: Likely `leads` table with name, email, created_at

**NOTE**: This is SEPARATE from the main Spectrum PostgreSQL on DigitalOcean. This D1 database is just for lead capture.

## Deployment Process

### Deploy Command
```bash
cd "/Users/aijesusbro/AI Projects/aijesusbro.com/spectrum"
./deploy.sh
```

### What Happens
1. Builds with Vite: `npm run build` (creates `/dist`)
2. Deploys to CloudFlare Pages: `npx wrangler pages deploy dist`
3. CloudFlare Functions automatically deployed from `/functions/api/`

### Manual Deployment
```bash
# Build frontend
npm run build

# Deploy to CloudFlare Pages
npx wrangler pages deploy dist --project-name=spectrum

# Or using package.json script
npm run deploy
```

## Frontend Features

### Lead Gate
- Shows before chat interface
- Collects: name, email
- Animated transition (GSAP)
- Stores submission in D1 database
- Cookie to remember submission

### Agent Selector
Displays 4 agents:
1. **The Strategist** (Blue) - Strategic planning
2. **The Builder** (Green) - Product & engineering
3. **The Closer** (Orange) - Revenue & sales
4. **The Operator** (Purple) - Operations & scale

### Chat Interface
- Streaming responses from Claude
- Markdown rendering for AI messages
- User messages in blue bubbles (right-aligned)
- AI messages in gray bubbles (left-aligned)
- Auto-scroll to latest message
- Typing indicator during responses

### API Calls (from app.js)
```javascript
// Get agents list
fetch('/api/agents')

// Start conversation
fetch('/api/conversations', {
    method: 'POST',
    body: JSON.stringify({ agent_id })
})

// Send message
fetch('/api/chat', {
    method: 'POST',
    body: JSON.stringify({
        conversation_id,
        message
    })
})
```

## CloudFlare Pages Configuration

### wrangler.toml
```toml
name = "spectrum"
compatibility_date = "2024-10-20"
pages_build_output_dir = "."

[[d1_databases]]
binding = "DB"
database_name = "spectrum-leads"
database_id = "c4de2db9-f8eb-4419-bdf6-647de1fb463e"

[vars]
ENVIRONMENT = "production"
```

### Routes
- `/` - Main page (index.html)
- `/api/*` - Proxied to DigitalOcean backend via Functions
- All static assets served from CloudFlare edge

## Backend Connection

### Proxy Configuration
- **Target**: `http://api.spectrum.aijesusbro.com:8082`
- **DNS**: `api.spectrum.aijesusbro.com` → `64.23.221.37` (A record)
- **Method**: HTTP proxy (not HTTPS, backend is plain HTTP)
- **CORS**: Handled by proxy function (adds headers)

### Why HTTP and Not HTTPS?
- DigitalOcean backend (64.23.221.37:8082) is plain HTTP
- CloudFlare Worker handles HTTPS termination
- Internal HTTP is fine since CloudFlare acts as SSL proxy

## File Structure

```
/aijesusbro.com/spectrum/
├── src/
│   ├── app.js              # Main frontend logic
│   └── styles.css          # Tailwind imports
├── functions/
│   └── api/
│       ├── [[path]].js     # Main proxy to DigitalOcean
│       ├── submit-lead.js  # Lead capture to D1
│       └── track-access.js # Analytics
├── dist/                   # Build output (gitignored)
├── index.html              # Main HTML page
├── config.html             # Admin config page?
├── wrangler.toml           # CloudFlare config
├── vite.config.js          # Vite bundler config
├── tailwind.config.js      # Tailwind CSS config
├── package.json            # Dependencies
└── deploy.sh               # Deployment script
```

## Dependencies (package.json)

```json
{
  "dependencies": {
    "gsap": "^3.x",     // Animations
    "marked": "^x.x"    // Markdown rendering
  },
  "devDependencies": {
    "vite": "^5.x",     // Build tool
    "tailwindcss": "^3.x"
  }
}
```

## Access URLs

- **Main Site**: https://spectrum.aijesusbro.com
- **API Health**: https://spectrum.aijesusbro.com/api/health
- **Direct Backend**: http://api.spectrum.aijesusbro.com:8082 (not publicly accessible)

## DNS Configuration

### A Records (CloudFlare DNS)
```
spectrum.aijesusbro.com       → CloudFlare Pages IP
api.spectrum.aijesusbro.com   → 64.23.221.37 (DigitalOcean)
```

**NOTE**: The frontend uses CloudFlare's proxy, so it doesn't directly call `api.spectrum.aijesusbro.com`. Instead, it calls `/api/*` which gets proxied by CloudFlare Functions.

## Related Systems

### Spectrum Production Backend
- Location: DigitalOcean (64.23.221.37:8082)
- See: `/system-map/03-Spectrum-Production.md`

### Lead Storage
- CloudFlare D1: `spectrum-leads`
- Purpose: Capture form submissions before chat

## Questions to Resolve

1. **Why `api.spectrum.aijesusbro.com`?**
   - The proxy uses this domain in BACKEND_URL
   - Does this A record exist in CloudFlare DNS?
   - Or should it be direct IP `64.23.221.37`?

2. **Config Page**: What is `config.html` used for?

3. **Track Access**: Does `track-access.js` actually work? What does it store?

## Last Updated
November 13, 2025
